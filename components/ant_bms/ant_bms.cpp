#include "ant_bms.h"
#include "esphome/core/log.h"
#include "esphome/core/helpers.h"

namespace esphome {
namespace ant_bms {

static const char *const TAG = "ant_bms";

static const uint8_t FUNCTION_READ_ALL = 0x06;

void AntBms::on_ant_modbus_data(const uint8_t &function, const std::vector<uint8_t> &data) {
  if (data.size() == 140) {
    this->on_status_data_(data);
    return;
  }

  ESP_LOGW(TAG, "Invalid size (%zu) for ANT BMS frame!", data.size());
}

void AntBms::on_status_data_(const std::vector<uint8_t> &data) {
  auto ant_get_16bit = [&](size_t i) -> uint16_t {
    return (uint16_t(data[i + 0]) << 8) | (uint16_t(data[i + 1]) << 0);
  };
  auto ant_get_32bit = [&](size_t i) -> uint32_t {
    return (uint32_t(ant_get_16bit(i + 0)) << 16) | (uint32_t(ant_get_16bit(i + 2)) << 0);
  };

  // Status request
  // -> 0x5A 0x5A 0x00 0x00 0x01 0x01
  //
  // Status response
  // <- 0xAA 0x55 0xAA 0xFF: Header
  //      0    1    2    3
  // *Data*
  //
  // Byte   Address Content: Description      Decoded content                         Coeff./Unit

  //   4    0x02 0x1D: Total voltage         541 * 0.1 = 54.1V                        0.1 V
  //   6    0x10 0x2A: Cell 1                4138 * 0.001 = 4.138V                    0.001 V
  //   8    0x10 0x2A: Cell 2                4138 * 0.001 = 4.138V                    0.001 V
  //  10    0x10 0x27: Cell 3                4135 * 0.001 = 4.135V                    0.001 V
  //  12    0x10 0x2A: Cell 4                                                         0.001 V
  //  14    0x10 0x2A: Cell 5                                                         0.001 V
  //  16    0x10 0x28: Cell 6                                                         0.001 V
  //  18    0x10 0x28: Cell 7                                                         0.001 V
  //  20    0x10 0x28: Cell 8                                                         0.001 V
  //  22    0x10 0x26: Cell 9                                                         0.001 V
  //  24    0x10 0x29: Cell 10                                                        0.001 V
  //  26    0x10 0x28: Cell 11                                                        0.001 V
  //  28    0x10 0x29: Cell 12                                                        0.001 V
  //  30    0x10 0x2C: Cell 13                                                        0.001 V
  //  32    0x00 0x00: Cell 14                                                        0.001 V
  //  34    0x00 0x00: Cell 15                                                        0.001 V
  //  36    0x00 0x00: Cell 16                                                        0.001 V
  //  38    0x00 0x00: Cell 17                                                        0.001 V
  //  40    0x00 0x00: Cell 18                                                        0.001 V
  //  42    0x00 0x00: Cell 19                                                        0.001 V
  //  44    0x00 0x00: Cell 20                                                        0.001 V
  //  46    0x00 0x00: Cell 21                                                        0.001 V
  //  48    0x00 0x00: Cell 22                                                        0.001 V
  //  50    0x00 0x00: Cell 23                                                        0.001 V
  //  52    0x00 0x00: Cell 24                                                        0.001 V
  //  54    0x00 0x00: Cell 25                                                        0.001 V
  //  56    0x00 0x00: Cell 26                                                        0.001 V
  //  58    0x00 0x00: Cell 27                                                        0.001 V
  //  60    0x00 0x00: Cell 28                                                        0.001 V
  //  62    0x00 0x00: Cell 29                                                        0.001 V
  //  64    0x00 0x00: Cell 30                                                        0.001 V
  //  66    0x00 0x00: Cell 31                                                        0.001 V
  //  68    0x00 0x00: Cell 32                                                        0.001 V
  //  70    0x00 0x00 0x00 0x00: Current               0.0 A                          0.1 A
  //  74    0x64: SOC                                  100 %                          1.0 %
  //  75    0x02 0x53 0x17 0xC0: Total Battery Capacity Setting   39000000            0.000001 Ah
  //  79    0x02 0x53 0x06 0x11: Battery Capacity Remaining                           0.000001 Ah
  //  83    0x00 0x08 0xC7 0x8E: Battery Cycle Capacity                               0.001 Ah
  //  87    0x00 0x08 0x57 0x20: Uptime in seconds     546.592 s / 3600 = 151.83 h    s
  //  91    0x00 0x15: Temperature 1                   21°C                           1.0 °C
  //  93    0x00 0x15: Temperature 2                   21°C                           1.0 °C
  //  95    0x00 0x14: Temperature 3                   20°C                           1.0 °C
  //  97    0x00 0x14: Temperature 4                   20°C                           1.0 °C
  //  99    0x00 0x14: Temperature 5                   20°C                           1.0 °C
  //  101   0x00 0x14: Temperature 6                   20°C                           1.0 °C
  //  103   0x01: Charge MOSFET Status
  //  104   0x01: Discharge MOSFET Status
  //  105   0x00: Balancer Status
  //  106   0x03 0xE8: Tire length                                                    mm
  //  108   0x00 0x17: Number of pulses per week
  //  110   0x01: Relay switch
  //  111   0x00 0x00 0x00 0x00: Current power         0W                             1.0 W
  //  115   0x0D: Cell with the highest voltage        Cell 13
  //  116   0x10 0x2C: Maximum cell voltage            4140 * 0.001 = 4.140V          0.001 V
  //  118   0x09: Cell with the lowest voltage         Cell 9
  //  119   0x10 0x26: Minimum cell voltage            4134 * 0.001 = 4.134V          0.001 V
  //  121   0x10 0x28: Average cell voltage            4136 * 0.001 = 4.136V          0.001 V
  //  123   0x0D: Cell count                           13
  //  124   0x00 0x00: Discharge MOSFET, voltage between D-S                          0.1 V
  //  126   0x00 0x73: Drive voltage (discharge MOSFET)                               0.1 V
  //  128   0x00 0x6F: Drive voltage (charge MOSFET)                                  0.1 V
  //  130   0x02 0xA7: When the detected current is 0, the initial value of the comparator
  //  132   0x00 0x00 0x00 0x00: Battery is in balance bitmask (Bit 1 = Cell 1, Bit 2 = Cell 2, ...)
  //  136   0x11 0x62: System log / overall status bitmask?
  //  138   0x0B 0x00: CRC

  ESP_LOGI(TAG, "Status frame received");
}

void AntBms::update() {
  this->read_registers();

  //  this->on_ant_modbus_data(
  //      FUNCTION_READ_ALL,
  //      {
  //          0xAA, 0x55, 0xAA, 0xFF, 0x00, 0x77, 0x00, 0x03, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00,
  //          0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
  //          0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x17, 0x17, 0x00, 0x1C, 0x00, 0x1D, 0xFF, 0xE2, 0xFF, 0xE2, 0x00, 0x00, 0x00,
  //          0x00, 0x09, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x40, 0x00, 0x05, 0x30,
  //      });
  //  this->on_ant_modbus_data(
  //      FUNCTION_READ_ALL,
  //      {
  //          0xAA, 0x55, 0xAA, 0xFF, 0x02, 0x1D, 0x10, 0x2A, 0x10, 0x2A, 0x10, 0x27, 0x10, 0x2A, 0x10, 0x2A, 0x10,
  //          0x28, 0x10, 0x28, 0x10, 0x28, 0x10, 0x26, 0x10, 0x29, 0x10, 0x28, 0x10, 0x29, 0x10, 0x2C, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x02, 0x53, 0x17, 0xC0, 0x02, 0x53, 0x06, 0x11, 0x00, 0x08,
  //          0xC7, 0x8E, 0x00, 0x08, 0x57, 0x20, 0x00, 0x15, 0x00, 0x15, 0x00, 0x14, 0x00, 0x14, 0x00, 0x14, 0x00,
  //          0x14, 0x01, 0x01, 0x00, 0x03, 0xE8, 0x00, 0x17, 0x01, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x10, 0x2C, 0x09,
  //          0x10, 0x26, 0x10, 0x28, 0x0D, 0x00, 0x00, 0x00, 0x73, 0x00, 0x6F, 0x02, 0xA7, 0x00, 0x00, 0x00, 0x00,
  //          0x11, 0x62, 0x0B, 0x00,
  //      });
  //  this->on_ant_modbus_data(
  //      FUNCTION_READ_ALL,
  //      {
  //          0xAA, 0x55, 0xAA, 0xFF, 0x02, 0x1D, 0x10, 0x2A, 0x10, 0x2A, 0x10, 0x27, 0x10, 0x2A, 0x10, 0x2A, 0x10,
  //          0x28, 0x10, 0x28, 0x10, 0x28, 0x10, 0x26, 0x10, 0x29, 0x10, 0x28, 0x10, 0x29, 0x10, 0x2C, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x02, 0x53, 0x17, 0xC0, 0x02, 0x53, 0x06, 0x10, 0x00, 0x08,
  //          0xC7, 0x8E, 0x00, 0x08, 0x57, 0x21, 0x00, 0x15, 0x00, 0x16, 0x00, 0x14, 0x00, 0x14, 0x00, 0x14, 0x00,
  //          0x14, 0x01, 0x01, 0x00, 0x03, 0xE8, 0x00, 0x17, 0x01, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x10, 0x2C, 0x09,
  //          0x10, 0x26, 0x10, 0x28, 0x0D, 0x00, 0x00, 0x00, 0x73, 0x00, 0x6F, 0x02, 0xA7, 0x00, 0x00, 0x00, 0x00,
  //          0x15, 0x62, 0x0B, 0x00,
  //      });
  //  this->on_ant_modbus_data(
  //      FUNCTION_READ_ALL,
  //      {
  //          0xAA, 0x55, 0xAA, 0xFF, 0x02, 0x1D, 0x10, 0x2A, 0x10, 0x2A, 0x10, 0x27, 0x10, 0x2A, 0x10, 0x2A, 0x10,
  //          0x28, 0x10, 0x28, 0x10, 0x28, 0x10, 0x26, 0x10, 0x29, 0x10, 0x28, 0x10, 0x29, 0x10, 0x2C, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  //          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x02, 0x53, 0x17, 0xC0, 0x02, 0x53, 0x06, 0x11, 0x00, 0x08,
  //          0xC7, 0x8E, 0x00, 0x08, 0x57, 0x1F, 0x00, 0x15, 0x00, 0x16, 0x00, 0x14, 0x00, 0x14, 0x00, 0x14, 0x00,
  //          0x14, 0x01, 0x01, 0x00, 0x03, 0xE8, 0x00, 0x17, 0x01, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x10, 0x2C, 0x09,
  //          0x10, 0x26, 0x10, 0x28, 0x0D, 0x00, 0x00, 0x00, 0x73, 0x00, 0x6F, 0x02, 0xA7, 0x00, 0x00, 0x00, 0x00,
  //          0x0D, 0x62, 0x0B, 0x00,
  //      });
}

void AntBms::publish_state_(sensor::Sensor *sensor, float value) {
  if (sensor == nullptr)
    return;

  sensor->publish_state(value);
}

void AntBms::dump_config() {  // NOLINT(google-readability-function-size,readability-function-size)
  ESP_LOGCONFIG(TAG, "AntBms:");
  ESP_LOGCONFIG(TAG, "  Address: 0x%02X", this->address_);

  LOG_SENSOR("", "Capacity Remaining", this->capacity_remaining_sensor_);
}

}  // namespace ant_bms
}  // namespace esphome
